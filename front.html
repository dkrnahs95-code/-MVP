<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ ˆä¸ªäººä»ªè¡¨ç›˜ (Ultimateç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary-blue: #1890ff;
            --primary-teal: #13c2c2;
            --feishu-color: #00d6b9;
            --text-main: #333;
        }
        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg-color);
            margin: 0; padding: 20px; color: var(--text-main); height: 100vh;
            box-sizing: border-box; display: flex; flex-direction: column; gap: 20px;
        }
        
        /* é¡¶éƒ¨ Header */
        header {
            background: var(--card-bg); padding: 15px 25px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        
        /* è¯­å½•è¾“å…¥æ¡† */
        #quote-display { cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: background 0.2s; }
        #quote-display:hover { background: #f0f0f0; }
        .quote-input { width: 400px; padding: 5px; font-family: inherit; font-size: inherit; border: 1px solid #1890ff; outline: none;}

        /* è‡ªå®šä¹‰è¿›åº¦æ¡ (Range Slider) */
        .progress-wrapper { display: flex; align-items: center; gap: 10px; width: 200px; }
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--primary-blue); cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px;
        }

        main {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            flex-grow: 1; overflow: hidden;
        }
        .panel {
            background: var(--card-bg); border-radius: 8px; padding: 20px;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;
        }
        /* æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ */
        .date-picker {
            border: 1px solid #ddd; padding: 5px; border-radius: 4px; 
            font-family: inherit; color: #555; margin-right: 5px;
        }

        .scroll-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type=text], input[type=time] { padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; outline: none; }
        
        /* å¾…åŠåˆ—è¡¨ */
        .todo-item {
            display: flex; align-items: center; padding: 10px; margin-bottom: 8px;
            background: #fff; border: 1px solid #eee; border-radius: 6px;
            transition: all 0.2s; position: relative;
        }
        .todo-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .todo-time {
            font-weight: bold; color: #555; width: 60px; text-align: center;
            background: #f5f5f5; padding: 4px; border-radius: 4px; margin-right: 12px;
        }
        .todo-content { flex-grow: 1; font-weight: 500; }

        /* é£ä¹¦æ ·å¼ä¼˜åŒ–ï¼šå»æ‰æ–‡å­—æ ‡ç­¾ï¼Œä»…ç”¨é¢œè‰²æç¤º */
        .todo-feishu { border-left: 5px solid var(--feishu-color); background: #f0fffd; }
        .todo-feishu-modified { border-left: 5px solid #009688; background: #e0f2f1; }
        
        /* æ“ä½œæŒ‰é’® */
        .btn-group { display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; }
        .todo-item:hover .btn-group { opacity: 1; }
        .icon-btn { border: none; background: none; cursor: pointer; color: #999; font-size: 1.1em; }
        .icon-btn:hover { color: #1890ff; }
        .icon-btn.del:hover { color: #ff4d4f; }
        .action-btn { border: none; padding: 8px 16px; border-radius: 4px; color: white; cursor: pointer; }

        /* å³ä¾§å¡ç‰‡ */
        .info-card {
            padding: 15px; margin-bottom: 10px; border-radius: 4px;
            background: #fffbe6; border-left: 4px solid #faad14; cursor: pointer; position: relative;
        }
        .card-ai { background: #f9f0ff; border-left-color: #722ed1; cursor: pointer; } /* AIä¹Ÿæ”¯æŒæŒ‡é’ˆ */

        .card-del-btn {
            position: absolute; top: 5px; right: 5px; display: none;
            border: none; background: transparent; cursor: pointer; font-size: 1.2em; color: #aaa;
        }
        .card-del-btn:hover { color: #ff4d4f; }
        .info-card:hover .card-del-btn { display: block; }

    </style>
</head>
<body>

    <header>
        <!-- è¯­å½•æ˜¾ç¤ºåŒº -->
        <div id="quote-wrapper" style="font-style:italic; color:#666; display:flex; align-items:center;">
            <span>ğŸŒŸ </span>
            <div id="quote-display" onclick="editQuote()" title="ç‚¹å‡»ç¼–è¾‘ï¼Œæ¸…ç©ºä¿å­˜å¯æ¢å¤éšæœº">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- è¿›åº¦æ¡åŒº -->
        <div class="progress-wrapper">
            <span style="font-size:0.8em; color:#888;">æœ¬å‘¨è¿›åº¦: <span id="progress-val">0</span>%</span>
            <input type="range" id="progress-bar" min="0" max="100" value="0" onchange="saveProgress()">
        </div>
    </header>

    <main>
        <!-- å·¦ä¾§ -->
        <section class="panel">
            <div class="panel-header">
                <h2>ğŸ“… æ—¥ç¨‹è¡¨</h2>
                <div style="display:flex; align-items:center;">
                    <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
                    <input type="date" id="sync-date" class="date-picker">
                    <button class="action-btn" style="background:var(--feishu-color);" onclick="syncFeishu()">åŒæ­¥</button>
                </div>
            </div>
            
            <div class="input-group">
                <input type="time" id="task-time" value="09:00">
                <input type="text" id="task-desc" placeholder="æ·»åŠ æ‰‹åŠ¨ä»»åŠ¡..." style="flex-grow:1;">
                <button class="action-btn" style="background:#1890ff;" onclick="addTask()">æ·»åŠ </button>
            </div>
            <div id="todo-list" class="scroll-list"></div>
        </section>

        <!-- å³ä¾§ -->
        <section class="panel">
            <div class="panel-header">
                <h2>ğŸ’¡ å¤‡å¿˜ / æƒ…æŠ¥</h2>
                <button class="action-btn" style="background:#722ed1;" onclick="refreshNews()">âš¡ æŠ“å–çƒ­ç‚¹</button>
            </div>
            <div class="input-group">
                <input type="text" id="info-input" placeholder="è¾“å…¥å¤‡å¿˜..." style="flex-grow:1;">
                <button class="action-btn" style="background:#1890ff;" onclick="addManualCard()">è®°å½•</button>
            </div>
            <div id="info-cards" class="scroll-list"></div>
        </section>
    </main>

    <script>
        const API_URL = 'http://127.0.0.1:5000/api';

        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨ä¸ºä»Šå¤©
        document.getElementById('sync-date').valueAsDate = new Date();

        async function loadData() {
            const res = await fetch(`${API_URL}/data`);
            const data = await res.json();
            
            // æ¸²æŸ“åˆ—è¡¨
            renderTodos(data.todos);
            renderCards(data.cards);
            
            // æ¸²æŸ“è®¾ç½®ï¼šè¿›åº¦æ¡
            if(data.settings) {
                const p = data.settings.progress || 0;
                document.getElementById('progress-bar').value = p;
                document.getElementById('progress-val').innerText = p;

                // æ¸²æŸ“è®¾ç½®ï¼šè¯­å½•
                const quoteDiv = document.getElementById('quote-display');
                if (data.settings.custom_quote) {
                    quoteDiv.innerText = `"${data.settings.custom_quote}"`;
                } else {
                    quoteDiv.innerText = `"${data.random_quote}"`; // ä½¿ç”¨åç«¯å‘æ¥çš„éšæœºè¯­å½•
                }
            }
        }

        // --- æ¸²æŸ“åˆ—è¡¨ (è§£å†³â€œé£ä¹¦â€äºŒå­—å¤šä½™çš„é—®é¢˜) ---
        function renderTodos(todos) {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            if(!todos) return;

            todos.sort((a,b) => (a.time > b.time) ? 1 : -1);

            todos.forEach(task => {
                const div = document.createElement('div');
                
                // ä»…ä½¿ç”¨é¢œè‰²åŒºåˆ†ï¼Œä¸å†åŠ æ–‡å­—æ ‡ç­¾
                let cssClass = 'todo-item';
                if (task.type === 'feishu') cssClass += ' todo-feishu';
                else if (task.type === 'feishu-modified') cssClass += ' todo-feishu-modified';
                
                div.className = cssClass;
                div.innerHTML = `
                    <div class="todo-time">${task.time}</div>
                    <!-- ç›´æ¥æ˜¾ç¤º descï¼Œä¸åŠ ä»»ä½•å‰ç¼€ -->
                    <div class="todo-content" id="content-${task.id}">${task.desc}</div>
                    <div class="btn-group">
                        <button class="icon-btn" onclick="toggleEditTodo(${task.id}, '${task.time}', '${task.desc.replace(/'/g, "\\'")}')">âœï¸</button>
                        <button class="icon-btn del" onclick="deleteTodo(${task.id})">Ã—</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- æ¸²æŸ“å¡ç‰‡ (è§£å†³ç´«è‰²å¡ç‰‡ä¸èƒ½åˆ çš„é—®é¢˜) ---
        function renderCards(cards) {
            const list = document.getElementById('info-cards');
            list.innerHTML = '';
            if(!cards) return;

            cards.forEach(card => {
                const div = document.createElement('div');
                div.className = card.type === 'ai' ? 'info-card card-ai' : 'info-card';
                div.innerHTML = `
                    <div id="card-content-${card.id}">${card.content}</div>
                    <!-- ç°åœ¨æ‰€æœ‰å¡ç‰‡éƒ½æœ‰åˆ é™¤æŒ‰é’® -->
                    <button class="card-del-btn" onclick="deleteCard(${card.id})">Ã—</button>
                `;
                // å¤‡å¿˜å½•å¯ç¼–è¾‘ (AIå¡ç‰‡ä¿æŒåªè¯»ï¼Œä»…å¯åˆ é™¤)
                if(card.type !== 'ai') {
                    div.onclick = (e) => {
                         if(e.target.tagName !== 'BUTTON') toggleEditCard(card.id, card.content);
                    }
                }
                list.appendChild(div);
            });
        }

        // ==========================
        // âš™ï¸ æ–°å¢äº¤äº’é€»è¾‘
        // ==========================
        
        // 1. ä¿å­˜è¿›åº¦æ¡
        async function saveProgress() {
            const val = document.getElementById('progress-bar').value;
            document.getElementById('progress-val').innerText = val;
            await fetch(`${API_URL}/settings`, {
                method: 'PUT', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ progress: parseInt(val) })
            });
        }

        // 2. ç¼–è¾‘è¯­å½•
        function editQuote() {
            const div = document.getElementById('quote-display');
            // å»æ‰å¼•å·æå–çº¯æ–‡æœ¬
            const currentText = div.innerText.replace(/^"|"$/g, ''); 
            div.innerHTML = `<input type="text" id="quote-input" class="quote-input" value="${currentText}" onblur="saveQuote()" onkeydown="if(event.key==='Enter') saveQuote()">`;
            setTimeout(() => document.getElementById('quote-input').focus(), 100);
            div.onclick = null; // æš‚æ—¶ç¦ç”¨ç‚¹å‡»
        }

        async function saveQuote() {
            const val = document.getElementById('quote-input').value;
            // å¦‚æœæ¸…ç©ºäº†ï¼Œä¼ ç©ºå­—ç¬¦ä¸²ç»™åç«¯ï¼Œåç«¯ä¸‹æ¬¡å°±ä¼šå‘éšæœºçš„
            await fetch(`${API_URL}/settings`, {
                method: 'PUT', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ custom_quote: val })
            });
            // æ¢å¤ç‚¹å‡»äº‹ä»¶å¹¶åˆ·æ–°
            document.getElementById('quote-display').onclick = editQuote;
            loadData();
        }

        // 3. å¸¦æ—¥æœŸçš„é£ä¹¦åŒæ­¥
        async function syncFeishu() {
            const btn = event.target; btn.innerText = '...';
            const dateVal = document.getElementById('sync-date').value; // è·å–é€‰æ‹©çš„æ—¥æœŸ
            
            await fetch(`${API_URL}/sync/feishu`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ date: dateVal }) // å‘é€æ—¥æœŸ
            });
            
            btn.innerText = 'åŒæ­¥'; loadData();
        }

        // ==========================
        // âœï¸ åŸæœ‰ç¼–è¾‘ä¸ CRUD é€»è¾‘
        // ==========================
        function toggleEditTodo(id, time, desc) {
            const container = document.getElementById(`content-${id}`);
            container.innerHTML = `
                <div style="display:flex; gap:5px;">
                    <input type="time" id="e-time-${id}" value="${time}">
                    <input type="text" id="e-desc-${id}" value="${desc}" style="width:100%;">
                    <button class="action-btn" style="background:#1890ff; padding:2px 8px;" onclick="saveTodo(${id})">ok</button>
                </div>
            `;
        }
        async function saveTodo(id) {
            const t = document.getElementById(`e-time-${id}`).value;
            const d = document.getElementById(`e-desc-${id}`).value;
            await fetch(`${API_URL}/todos/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({time:t, desc:d})});
            loadData();
        }
        function toggleEditCard(id, content) {
            if(document.getElementById(`e-card-${id}`)) return;
            const div = document.getElementById(`card-content-${id}`);
            const text = div.innerText.replace('ğŸ“ å¤‡å¿˜ï¼š', '').trim();
            div.innerHTML = `<textarea id="e-card-${id}" style="width:95%;">${text}</textarea> <button class="action-btn" style="background:#1890ff; padding:2px 8px; margin-top:5px;" onclick="saveCard(${id})">ä¿å­˜</button>`;
        }
        async function saveCard(id) {
            const val = document.getElementById(`e-card-${id}`).value;
            await fetch(`${API_URL}/cards/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content:`<strong>ğŸ“ å¤‡å¿˜ï¼š</strong> ${val}`})});
            loadData();
        }
        async function addTask() {
            const t = document.getElementById('task-time').value; const d = document.getElementById('task-desc').value; if(!d) return;
            await fetch(`${API_URL}/todos`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({time:t, desc:d})});
            document.getElementById('task-desc').value=''; loadData();
        }
        async function deleteTodo(id) { await fetch(`${API_URL}/todos/${id}`, {method:'DELETE'}); loadData(); }
        async function addManualCard() {
            const d = document.getElementById('info-input').value; if(!d) return;
            await fetch(`${API_URL}/cards`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content:`<strong>ğŸ“ å¤‡å¿˜ï¼š</strong> ${d}`})});
            document.getElementById('info-input').value=''; loadData();
        }
        async function deleteCard(id) { await fetch(`${API_URL}/cards/${id}`, {method:'DELETE'}); loadData(); }
        async function refreshNews() { await fetch(`${API_URL}/agent/news`, {method:'POST'}); loadData(); }

        loadData();
    </script>
</body>
</html>