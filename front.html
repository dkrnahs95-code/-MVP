<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ ˆä¸ªäººä»ªè¡¨ç›˜ (Ultimateç‰ˆ)</title>
    <style>
        /* CSS æ ·å¼ä¿æŒä¸€è‡´ï¼Œå¢åŠ äº†å¡ç‰‡åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary-blue: #1890ff;
            --primary-purple: #722ed1;
            --primary-teal: #13c2c2;
            --text-main: #262626;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px;
            color: var(--text-main); height: 100vh;
            box-sizing: border-box;
            display: flex; flex-direction: column; gap: 20px;
        }

        header {
            background: var(--card-bg); padding: 15px 25px;
            border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .progress-box { display: flex; align-items: center; gap: 10px; width: 300px; }
        progress { flex-grow: 1; height: 10px; border-radius: 5px; }

        main {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            flex-grow: 1; overflow: hidden;
        }

        .panel {
            background: var(--card-bg); border-radius: 8px; padding: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;
        }
        .panel-header h2 { margin: 0; font-size: 1.2rem; }

        .scroll-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; }

        /* å·¦ä¾§åˆ—è¡¨æ ·å¼ */
        .todo-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; margin-bottom: 8px; background: #fafafa;
            border-left: 3px solid #d9d9d9; border-radius: 0 4px 4px 0;
        }
        .todo-feishu { border-left-color: var(--primary-teal); background: #e6fffb; }

        /* å³ä¾§å¡ç‰‡æ ·å¼ (å‡çº§ç‰ˆï¼šæ”¯æŒç›¸å¯¹å®šä½ä»¥æ”¾ç½®åˆ é™¤æŒ‰é’®) */
        .info-card {
            position: relative; /* å…³é”®ï¼šä¸ºäº†è®©åˆ é™¤æŒ‰é’®ç»å¯¹å®šä½ */
            padding: 15px; padding-right: 30px; /* å³è¾¹ç•™ç©ºç»™åˆ é™¤æŒ‰é’® */
            margin-bottom: 10px; border-radius: 4px;
            background: #fffbe6; border-left: 4px solid #faad14;
            font-size: 0.95rem; line-height: 1.5;
            transition: transform 0.2s;
        }
        .info-card:hover { transform: translateX(2px); }
        .info-card a { color: var(--primary-blue); text-decoration: none; font-weight: bold; }
        
        .card-ai { background: #f9f0ff; border-left-color: var(--primary-purple); }

        /* å¡ç‰‡å³ä¸Šè§’çš„åˆ é™¤å°å‰å· */
        .card-delete-btn {
            position: absolute; top: 5px; right: 5px;
            background: transparent; color: #ccc;
            border: none; font-size: 1.2rem; line-height: 1;
            cursor: pointer; padding: 0 5px;
        }
        .card-delete-btn:hover { color: #ff4d4f; }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        button.action-btn {
            border: none; padding: 8px 16px; border-radius: 4px;
            cursor: pointer; color: white; font-weight: 500;
        }
        button.action-btn:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-blue { background: var(--primary-blue); }
        .btn-teal { background: var(--primary-teal); }
        .btn-purple { background: var(--primary-purple); }
        .btn-del-todo { background: #ff4d4f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;}

    </style>
</head>
<body>

    <header>
        <div id="quote">ğŸŒŸ "æˆ‘ä»¬çš„ç»³å­ä¸Šå·²ç»æ‰“äº†å¤ªå¤šäººçš„ç»“ã€‚"</div>
        <div class="progress-box">
            <span>æœ¬å‘¨è¿›åº¦</span>
            <progress value="45" max="100"></progress>
        </div>
    </header>

    <main>
        <!-- å·¦ä¾§ï¼šå¾…åŠ -->
        <section class="panel">
            <div class="panel-header">
                <h2>ğŸ“ æ—¶é—´è½´å¾…åŠ</h2>
                <button class="action-btn btn-teal" onclick="syncFeishu()">ğŸ”„ åŒæ­¥é£ä¹¦</button>
            </div>
            <div class="input-group">
                <input type="time" id="task-time">
                <input type="text" id="task-desc" placeholder="è¾“å…¥ä»»åŠ¡..." style="flex-grow:1;">
                <button class="action-btn btn-blue" onclick="addTask()">æ·»åŠ </button>
            </div>
            <div id="todo-list" class="scroll-list"></div>
        </section>

        <!-- å³ä¾§ï¼šä¿¡æ¯æµ -->
        <section class="panel">
            <div class="panel-header">
                <h2>ğŸ’¡ çƒ­é—¨ä¿¡æ¯ / å¤‡å¿˜</h2>
                <button class="action-btn btn-purple" onclick="refreshNews()">âš¡ æŠ“å– AI çƒ­ç‚¹</button>
            </div>
            <div class="input-group">
                <input type="text" id="info-input" placeholder="è¾“å…¥å¤‡å¿˜ï¼Œåˆ·æ–°ä¸ä¸¢å¤±..." style="flex-grow:1;">
                <!-- æ³¨æ„ï¼šç°åœ¨è¿™é‡Œè°ƒç”¨ addManualCard -->
                <button class="action-btn btn-blue" onclick="addManualCard()">è®°å½•</button>
            </div>
            <div id="info-cards" class="scroll-list"></div>
        </section>
    </main>

    <script>
        const API_URL = 'http://127.0.0.1:5000/api';

        // 1. åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/data`);
                const data = await response.json();

                // æ¸²æŸ“å¾…åŠ
                const todoList = document.getElementById('todo-list');
                todoList.innerHTML = '';
                if (data.todos) {
                    data.todos.sort((a, b) => (a.time > b.time) ? 1 : -1);
                    data.todos.forEach(task => {
                        const div = document.createElement('div');
                        const isFeishu = task.desc.includes('[é£ä¹¦]');
                        div.className = isFeishu ? 'todo-item todo-feishu' : 'todo-item';
                        div.innerHTML = `
                            <span><strong>${task.time}</strong> &nbsp; ${task.desc}</span>
                            <button class="btn-del-todo" onclick="deleteTodo(${task.id})">åˆ é™¤</button>
                        `;
                        todoList.appendChild(div);
                    });
                }

                // æ¸²æŸ“å¡ç‰‡ (é‡å¤§æ›´æ–°)
                const cardList = document.getElementById('info-cards');
                cardList.innerHTML = '';
                if (data.cards && data.cards.length > 0) {
                    data.cards.forEach(card => {
                        const div = document.createElement('div');
                        // æ ¹æ® type å­—æ®µåˆ¤æ–­é¢œè‰²
                        if (card.type === 'ai') {
                            div.className = 'info-card card-ai';
                        } else {
                            div.className = 'info-card'; // é»˜è®¤é»„è‰²å¤‡å¿˜
                        }
                        
                        // æ’å…¥å†…å®¹ + åˆ é™¤æŒ‰é’®
                        // æ³¨æ„ï¼šè¿™é‡ŒæŠŠ card.id ä¼ ç»™äº† deleteCard å‡½æ•°
                        div.innerHTML = `
                            ${card.content}
                            <button class="card-delete-btn" onclick="deleteCard(${card.id})" title="åˆ é™¤">Ã—</button>
                        `;
                        cardList.appendChild(div);
                    });
                } else {
                    cardList.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">æš‚æ— ä¿¡æ¯</div>';
                }
            } catch (error) {
                console.error(error);
            }
        }

        // 2. æ·»åŠ å¾…åŠ
        async function addTask() {
            const timeVal = document.getElementById('task-time').value || 'å¾…å®š';
            const descVal = document.getElementById('task-desc').value;
            if (!descVal) return;
            await fetch(`${API_URL}/todos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ time: timeVal, desc: descVal })
            });
            document.getElementById('task-desc').value = '';
            loadData();
        }

        // 3. åˆ é™¤å¾…åŠ
        async function deleteTodo(id) {
            if (!confirm('åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) return;
            await fetch(`${API_URL}/todos/${id}`, { method: 'DELETE' });
            loadData();
        }

        // 4. æ–°åŠŸèƒ½ï¼šæ·»åŠ æ‰‹åŠ¨å¤‡å¿˜ (æŒä¹…åŒ–ä¿å­˜)
        async function addManualCard() {
            const input = document.getElementById('info-input');
            const val = input.value;
            if (!val) return;

            // å‘é€åˆ°åç«¯ä¿å­˜
            await fetch(`${API_URL}/cards`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: `<strong>ğŸ“ å¤‡å¿˜ï¼š</strong> ${val}` })
            });
            
            input.value = '';
            loadData(); // é‡æ–°åŠ è½½ï¼Œè¿™æ ·å°±èƒ½çœ‹åˆ°æ–°ä¿å­˜çš„å¡ç‰‡äº†
        }

        // 5. æ–°åŠŸèƒ½ï¼šåˆ é™¤å¡ç‰‡ (æ— è®ºæ˜¯æ–°é—»è¿˜æ˜¯å¤‡å¿˜)
        async function deleteCard(id) {
            // ä¸å†å¼¹çª—ç¡®è®¤ï¼Œç›´æ¥åˆ ï¼Œä½“éªŒæ›´å¥½
            await fetch(`${API_URL}/cards/${id}`, { method: 'DELETE' });
            loadData();
        }

        // 6. è¾…åŠ©åŠŸèƒ½
        async function refreshNews() {
            const btn = event.target; btn.innerText = 'æŠ“å–ä¸­...'; btn.disabled = true;
            await fetch(`${API_URL}/agent/news`, { method: 'POST' });
            btn.innerText = 'âš¡ æŠ“å– AI çƒ­ç‚¹'; btn.disabled = false;
            loadData();
        }

        async function syncFeishu() {
            const btn = event.target; btn.innerText = 'åŒæ­¥ä¸­...'; btn.disabled = true;
            await fetch(`${API_URL}/sync/feishu`, { method: 'POST' });
            btn.innerText = 'ğŸ”„ åŒæ­¥é£ä¹¦'; btn.disabled = false;
            loadData();
        }

        loadData();
    </script>
</body>
</html>